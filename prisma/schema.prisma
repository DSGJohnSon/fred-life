// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// FEATURE: WORKSPACES
// ============================================
model Workspace {
  id             String              @id @default(cuid())
  name           String
  avatarType     WorkspaceAvatarType @default(TEXT)
  avatar         String?
  avatarColor1   String?
  avatarColor2   String?
  avatarWithText Boolean?            @default(true)
  ownerId        String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  owner          User                @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members        WorkspaceMember[]

  //Historique du workspace
  auditLogs HistoryAuditLog[]

  // Relations avec finances
  accounts        Account[]
  categories      FinanceCategory[]
  financeAccounts FinanceAccount[]

  @@map("workspace")
}

model WorkspaceMember {
  id          String     @id @default(cuid())
  workspaceId String
  userId      String
  role        MemberRole @default(MEMBER)
  joinedAt    DateTime   @default(now())
  workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@map("workspace_member")
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum WorkspaceAvatarType {
  TEXT
  IMAGE
  COLOR
  GRADIENT
}

// ============================================
// FEATURE: FINANCES
// ============================================
model FinanceCategory {
  id           String               @id @default(cuid())
  workspaceId  String
  name         String
  type         FinanceCategoryType
  color        String? // Code couleur hex (#FF5733)
  icon         String? // Nom d'icône ou emoji
  parentId     String? // Pour sous-catégories (max 2 niveaux)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  workspace    Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  parent       FinanceCategory?     @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children     FinanceCategory[]    @relation("CategoryHierarchy")
  transactions FinanceTransaction[]

  @@map("category")
}

enum FinanceCategoryType {
  DEBIT // Uniquement pour les dépenses
  CREDIT // Uniquement pour les revenus
  BOTH // Peut être utilisée pour les deux
}

model FinanceAccount {
  id             String                   @id @default(cuid())
  workspaceId    String
  name           String // Ex: "Société Générale", "Revolut"
  initialBalance Decimal                  @default(0) @db.Decimal(12, 2)
  currency       String                   @default("EUR")
  isArchived     Boolean                  @default(false)
  archivedAt     DateTime?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  workspace      Workspace                @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  transactions   FinanceTransaction[]
  snapshots      FinanceAccountSnapshot[]
  transfersFrom  FinanceTransfer[]        @relation("TransferFrom")
  transfersTo    FinanceTransfer[]        @relation("TransferTo")

  @@map("finance_account")
}

model FinanceTransaction {
  id             String                 @id @default(cuid())
  accountId      String
  type           FinanceTransactionType @default(STANDARD)
  title          String // Titre court (ex: "Courses Carrefour")
  description    String? // Description détaillée optionnelle
  amount         Decimal                @db.Decimal(12, 2) // Positif = crédit, Négatif = débit
  date           DateTime // Date de la transaction
  categoryId     String? // Null pour les virements et ajustements
  isMarked       Boolean                @default(false)
  markedAt       DateTime?
  markedBy       String? // userId qui a marqué
  transferId     String?                @unique // Lien vers Transfer si virement
  createdAt      DateTime               @default(now())
  createdBy      String // userId créateur
  updatedAt      DateTime               @updatedAt
  deletedAt      DateTime? // Soft delete
  account        FinanceAccount         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category       FinanceCategory?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  transferDebit  FinanceTransfer?       @relation("TransferDebit")
  transferCredit FinanceTransfer?       @relation("TransferCredit")

  @@index([accountId, date])
  @@map("transaction")
}

enum FinanceTransactionType {
  STANDARD // Transaction normale
  ADJUSTMENT // Remise à niveau (crée un snapshot)
}

model FinanceTransfer {
  id                  String             @id @default(cuid())
  fromAccountId       String
  toAccountId         String
  amount              Decimal            @db.Decimal(12, 2) // Toujours positif
  date                DateTime
  title               String // Ex: "Virement SG → Revolut"
  description         String?
  debitTransactionId  String             @unique
  creditTransactionId String             @unique
  createdAt           DateTime           @default(now())
  createdBy           String // userId créateur
  fromAccount         FinanceAccount     @relation("TransferFrom", fields: [fromAccountId], references: [id], onDelete: Cascade)
  toAccount           FinanceAccount     @relation("TransferTo", fields: [toAccountId], references: [id], onDelete: Cascade)
  debitTransaction    FinanceTransaction @relation("TransferDebit", fields: [debitTransactionId], references: [id])
  creditTransaction   FinanceTransaction @relation("TransferCredit", fields: [creditTransactionId], references: [id])

  @@map("transfer")
}

model FinanceAccountSnapshot {
  id        String         @id @default(cuid())
  accountId String
  date      DateTime // Date du snapshot (ex: 2025-01-01 pour ouverture janvier)
  balance   Decimal        @db.Decimal(12, 2)
  reason    String? // Ex: "Ouverture janvier 2025", "Remise à niveau"
  createdAt DateTime       @default(now())
  createdBy String // userId créateur
  account   FinanceAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, date])
  @@map("account_snapshot")
}

// ============================================
// FEATURE: HISTORY (AUDIT LOG)
// ============================================
model HistoryAuditLog {
  id          String             @id @default(cuid())
  userId      String // Qui a fait l'action
  action      HistoryAuditAction
  entityType  HistoryEntityType // Type d'entité (Auth, Workspace, etc.)
  entityId    String? // ID de l'entité concernée (null si non concerné)
  workspaceId String? // ID du workspace concerné (null pour actions liés à l'utilisateur)
  changes     Json? // Détails des changements (before/after)
  ipAddress   String? // IP de l'utilisateur
  userAgent   String? // User agent du navigateur
  createdAt   DateTime           @default(now())
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace?         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@index([workspaceId, createdAt])
  @@map("audit_log")
}

enum HistoryAuditAction {
  // Actions génériques (workspaces, etc.)
  CREATE
  UPDATE
  DELETE
  // Actions d'authentification
  REGISTER
  LOGIN
  LOGIN_OAUTH
  // Actions spécifiques (futures)
  MARK
  UNMARK
  ARCHIVE
  UNARCHIVE
}

enum HistoryEntityType {
  Auth // Actions d'authentification
  Workspace // Actions sur les workspaces
}

// ============================================
// FEATURE: AUTH
// ============================================
model User {
  id            String   @id
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  accounts Account[]
  sessions Session[]

  ownedWorkspaces      Workspace[]       @relation("WorkspaceOwner")
  workspaceMemberships WorkspaceMember[]

  auditLogs HistoryAuditLog[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String     @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace             Workspace? @relation(fields: [workspaceId], references: [id])
  workspaceId           String?

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}
